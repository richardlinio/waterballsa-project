openapi: 3.0.3
info:
  title: WaterBall SA Backend API
  description: |
    Backend API for WaterBall SA Platform

    This API provides endpoints for the WaterBall SA learning platform, including health checks,
    journey management, and user interactions.
  version: 1.0.0
  contact:
    name: API Support
    email: support@waterballsa.tw
servers:
  - url: 'http://localhost:8080'
    description: Development server
  - url: 'https://api.waterballsa.tw'
    description: Production server
tags:
  - name: Health Check
    description: API health monitoring endpoints
  - name: Auth
    description: User authentication and authorization endpoints
  - name: Journeys
    description: Learning journey management endpoints
  - name: Missions
    description: Learning mission (video/article/questionnaire) management endpoints
  - name: Progress
    description: User mission progress tracking endpoints
  - name: Users
    description: User profile and information endpoints
  - name: Orders
    description: Course purchase order management endpoints
  - name: User Journeys
    description: User purchased journey access management endpoints
paths:
  /healthz:
    get:
      tags:
        - Health Check
      summary: Health check endpoint
      description: |
        Returns the database connection health status.

        Returns HTTP 200 when database is healthy, HTTP 503 when database is down.
      operationId: checkHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  summary: Database is healthy
                  value:
                    status: UP
                    database: UP
        '503':
          description: Service is unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                unhealthy:
                  summary: Database connection failed
                  value:
                    status: DOWN
                    database: DOWN
  /auth/register:
    post:
      tags:
        - Auth
      summary: User registration
      description: |
        Register a new user with username and password.

        **Rate Limiting:**
        - Maximum 5 registrations per IP per hour
        - Returns 400 with generic error message when rate limit exceeded (avoids information leakage)

        **Validation:**
        - Username and password must be alphanumeric with special characters allowed
        - Both have length limits
        - Initial experience points set to 0
        - Redirects to login page on success
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            examples:
              valid:
                summary: Valid registration
                value:
                  username: john_doe123
                  password: SecurePass123!
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
              examples:
                success:
                  summary: Registration successful
                  value:
                    message: Registration successful
                    userId: 1
        '400':
          description: Invalid request data or rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidFormat:
                  summary: Invalid username or password format
                  value:
                    error: Invalid username or password format
                rateLimited:
                  summary: Rate limit exceeded (generic message for security)
                  value:
                    error: Registration failed. Please try again later.
        '409':
          description: Username already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                duplicate:
                  summary: Username already taken
                  value:
                    error: Username already exists
  /auth/login:
    post:
      tags:
        - Auth
      summary: User login
      description: |
        Authenticate user with username and password.

        **Rate Limiting:**
        - Maximum 5 failed attempts per IP per 15 minutes
        - Returns 401 when rate limit exceeded (same as invalid credentials to avoid information leakage)

        **Security:**
        - Returns JWT access token (expires in 1 day)
        - Token should be included in Authorization header for protected endpoints
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              valid:
                summary: Valid login credentials
                value:
                  username: john_doe123
                  password: SecurePass123!
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
              examples:
                success:
                  summary: Login successful
                  value:
                    accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    user:
                      id: 1
                      username: john_doe123
                      experience: 0
        '401':
          description: Invalid credentials or rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid:
                  summary: Wrong username or password
                  value:
                    error: Invalid username or password
                rateLimited:
                  summary: Rate limit exceeded (same error message for security)
                  value:
                    error: Invalid username or password
  /auth/logout:
    post:
      tags:
        - Auth
      summary: User logout
      description: |
        Logout current user and invalidate the access token.

        **Token Invalidation:**
        - Access token is added to blacklist (stored in database)
        - Blacklist entries auto-expire when token expires
        - After logout, token cannot be used to access protected endpoints

        **Note:** Requires valid access token in Authorization header
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogoutResponse'
              examples:
                success:
                  summary: Logout successful
                  value:
                    message: Logout successful
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Invalid or missing token
                  value:
                    error: Unauthorized or invalid token
  /journeys:
    get:
      tags:
        - Journeys
      summary: Get journey list
      description: |
        Returns a list of all available learning journeys.

        **Public Access:**
        - No authentication required
        - Returns journey basic information including cover image, title, and description

        **Response:**
        - Returns all journeys that are not soft-deleted
        - Journeys are returned in creation order ((chronologically)
      operationId: getJourneys
      responses:
        '200':
          description: Successfully retrieved journey list
          content:
            application/json:
              schema:
                type: object
                required:
                  - journeys
                properties:
                  journeys:
                    type: array
                    items:
                      $ref: '#/components/schemas/JourneyListItem'
              examples:
                success:
                  summary: Journey list with multiple journeys
                  value:
                    journeys:
                      - id: 1
                        slug: design-patterns-mastery
                        title: 軟體設計模式精通之旅
                        description: 用 C.A. 模式大大提昇系統思維能力
                        coverImageUrl: 'https://example.com/cover1.jpg'
                        teacherName: 水球潘
                      - id: 2
                        slug: web-development-intro
                        title: Web 開發入門
                        description: 從零開始學習網頁開發
                        coverImageUrl: 'https://example.com/cover2.jpg'
                        teacherName: 林老師
  '/journeys/{journeyId}':
    get:
      tags:
        - Journeys
      summary: Get journey details
      description: |
        Returns detailed information about a specific journey, including all chapters and missions.

        **Public Access:**
        - No authentication required
        - Anyone can view journey structure and mission titles

        **Authentication (Optional):**
        - If JWT token is provided, response will include mission status for the authenticated user
        - Mission status shows progress: UNCOMPLETED, COMPLETED, or DELIVERED
        - Without authentication, status field will be null

        **Response Structure:**
        - Journey basic information
        - List of chapters with their missions
        - Each mission includes: id, type, title, access level, and status (if authenticated)
        - Mission details (video URLs, duration, content) are NOT included in this endpoint (use mission detail endpoint)

        **Note:**
        - Chapters and missions are ordered by their order_index
        - Mission access levels: PUBLIC (viewable by anyone), AUTHENTICATED (requires login), PURCHASED (requires journey purchase)
        - Mission status is retrieved from user_mission_progress table (defaults to UNCOMPLETED if no progress record exists)
      operationId: getJourneyDetail
      security:
        - bearerAuth: []
        - {}
      parameters:
        - name: journeyId
          in: path
          required: true
          description: Journey ID
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Successfully retrieved journey details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JourneyDetail'
              examples:
                authenticated:
                  summary: Journey with chapters and missions (authenticated user)
                  value:
                    id: 1
                    slug: design-patterns-mastery
                    title: 軟體設計模式精通之旅
                    description: 用 C.A. 模式大大提昇系統思維能力
                    coverImageUrl: 'https://example.com/cover1.jpg'
                    teacherName: 水球潘
                    userStatus:
                      hasPurchased: true
                      hasUnpaidOrder: false
                      unpaidOrderId: null
                    chapters:
                      - id: 1
                        title: 課程介紹
                        orderIndex: 1
                        missions:
                          - id: 1
                            type: VIDEO
                            title: 這門課手把手帶你成為架構設計的高手
                            accessLevel: PUBLIC
                            orderIndex: 1
                            status: DELIVERED
                          - id: 2
                            type: VIDEO
                            title: 你該知道：在 AI 的時代下，只會下 prompt 絕對寫不出好 Code
                            accessLevel: PUBLIC
                            orderIndex: 2
                            status: COMPLETED
                      - id: 2
                        title: 架構思維的 C.A. 模式
                        orderIndex: 2
                        missions:
                          - id: 3
                            type: VIDEO
                            title: 架構師該如何思考
                            accessLevel: PURCHASED
                            orderIndex: 1
                            status: UNCOMPLETED
                authenticatedWithUnpaidOrder:
                  summary: User has unpaid order for this journey
                  value:
                    id: 1
                    slug: design-patterns-mastery
                    title: 軟體設計模式精通之旅
                    description: 用 C.A. 模式大大提昇系統思維能力
                    coverImageUrl: 'https://example.com/cover1.jpg'
                    teacherName: 水球潘
                    userStatus:
                      hasPurchased: false
                      hasUnpaidOrder: true
                      unpaidOrderId: 123
                    chapters:
                      - id: 1
                        title: 課程介紹
                        orderIndex: 1
                        missions:
                          - id: 1
                            type: VIDEO
                            title: 這門課手把手帶你成為架構設計的高手
                            accessLevel: PUBLIC
                            orderIndex: 1
                            status: UNCOMPLETED
                      - id: 2
                        title: 架構思維的 C.A. 模式
                        orderIndex: 2
                        missions:
                          - id: 3
                            type: VIDEO
                            title: 架構師該如何思考
                            accessLevel: PURCHASED
                            orderIndex: 1
                            status: UNCOMPLETED
                authenticatedNotPurchased:
                  summary: User logged in but has not purchased this journey
                  value:
                    id: 1
                    slug: design-patterns-mastery
                    title: 軟體設計模式精通之旅
                    description: 用 C.A. 模式大大提昇系統思維能力
                    coverImageUrl: 'https://example.com/cover1.jpg'
                    teacherName: 水球潘
                    userStatus:
                      hasPurchased: false
                      hasUnpaidOrder: false
                      unpaidOrderId: null
                    chapters:
                      - id: 1
                        title: 課程介紹
                        orderIndex: 1
                        missions:
                          - id: 1
                            type: VIDEO
                            title: 這門課手把手帶你成為架構設計的高手
                            accessLevel: PUBLIC
                            orderIndex: 1
                            status: UNCOMPLETED
                      - id: 2
                        title: 架構思維的 C.A. 模式
                        orderIndex: 2
                        missions:
                          - id: 3
                            type: VIDEO
                            title: 架構師該如何思考
                            accessLevel: PURCHASED
                            orderIndex: 1
                            status: UNCOMPLETED
                unauthenticated:
                  summary: Journey with chapters and missions (unauthenticated)
                  value:
                    id: 1
                    slug: design-patterns-mastery
                    title: 軟體設計模式精通之旅
                    description: 用 C.A. 模式大大提昇系統思維能力
                    coverImageUrl: 'https://example.com/cover1.jpg'
                    teacherName: 水球潘
                    userStatus: null
                    chapters:
                      - id: 1
                        title: 課程介紹
                        orderIndex: 1
                        missions:
                          - id: 1
                            type: VIDEO
                            title: 這門課手把手帶你成為架構設計的高手
                            accessLevel: PUBLIC
                            orderIndex: 1
                            status: null
                          - id: 2
                            type: VIDEO
                            title: 你該知道：在 AI 的時代下，只會下 prompt 絕對寫不出好 Code
                            accessLevel: PUBLIC
                            orderIndex: 2
                            status: null
                      - id: 2
                        title: 架構思維的 C.A. 模式
                        orderIndex: 2
                        missions:
                          - id: 3
                            type: VIDEO
                            title: 架構師該如何思考
                            accessLevel: PURCHASED
                            orderIndex: 1
                            status: null
        '404':
          description: Journey not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Journey does not exist
                  value:
                    error: Journey not found
  '/journeys/{journeyId}/missions/{missionId}':
    get:
      tags:
        - Missions
      summary: Get mission details
      description: |
        Returns detailed information about a specific mission including content and rewards.

        **Note:** This endpoint does NOT include user progress. Use GET /users/{userId}/missions/{missionId}/progress for progress information.

        **Authentication:**
        - Requires valid JWT token

        **Response Includes:**
        - Mission basic information (id, chapterId, journeyId, type, title, description)
        - Content array (can have multiple content items like videos, articles, forms)
        - Reward information (experience points)
        - Free preview flag
        - Creation timestamp

        **Content Structure:**
        - Each mission can have multiple content items
        - Content types: video, article, form
        - Videos include durationSeconds field

        **Free Preview:**
        - All users can access missions with isFreePreview: true
        - Other missions require journey purchase (MVP: all accessible)
      operationId: getMissionDetail
      security:
        - bearerAuth: []
      parameters:
        - name: journeyId
          in: path
          required: true
          description: Journey ID
          schema:
            type: integer
            example: 1
        - name: missionId
          in: path
          required: true
          description: Mission ID
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Successfully retrieved mission details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MissionDetail'
              examples:
                videoMission:
                  summary: Video mission example
                  value:
                    id: 1
                    chapterId: 8
                    journeyId: 1
                    type: VIDEO
                    title: 課程介紹：這門課手把手帶你成為架構設計的高手
                    description: 思維升級：Christopher Alexander 模式六大要素及模式語言
                    isFreePreview: true
                    createdAt: 1733294001561
                    videoLength: '04:16'
                    reward:
                      exp: 100
                    content:
                      - id: 0
                        type: video
                        url: 'https://cdn.waterballsa.tw/software-design-pattern/videos/c8m1-0/c8m1-0.m3u8'
                        durationSeconds: 256
                articleMission:
                  summary: Article mission example
                  value:
                    id: 5
                    chapterId: 10
                    journeyId: 1
                    type: ARTICLE
                    title: UML 不是英文縮寫字
                    description: UML 統一塑模語言完整介紹
                    isFreePreview: false
                    createdAt: 1733294001561
                    reward:
                      exp: 100
                    content:
                      - id: 0
                        type: article
                        url: 'https://cdn.waterballsa.tw/articles/uml-intro.html'
                questionnaireMission:
                  summary: Questionnaire mission example
                  value:
                    id: 7
                    chapterId: 12
                    journeyId: 1
                    type: QUESTIONNAIRE
                    title: 課程回饋問卷
                    description: 請填寫課程回饋問卷，幫助我們改進課程內容
                    isFreePreview: false
                    createdAt: 1733294001561
                    reward:
                      exp: 50
                    content:
                      - id: 0
                        type: form
                        url: 'https://forms.waterballsa.tw/feedback-form-1'
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Invalid or missing token
                  value:
                    error: Unauthorized or invalid token
        '404':
          description: Mission not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Mission does not exist
                  value:
                    error: Mission not found
  '/users/{userId}/missions/{missionId}/progress':
    get:
      tags:
        - Progress
      summary: Get user's mission progress
      description: |
        Returns the user's progress for a specific mission.

        **Authentication:**
        - Requires valid JWT token

        **Response Includes:**
        - Mission ID
        - Current status (UNCOMPLETED, COMPLETED, DELIVERED)
        - Watch position in seconds (for VIDEO missions)

        **Status Meanings:**
        - UNCOMPLETED: Mission in progress or not started
        - COMPLETED: Mission completed but not delivered yet
        - DELIVERED: Mission delivered and rewards received

        **Note:**
        - For missions without progress record, returns default UNCOMPLETED status with watchPositionSeconds: 0
      operationId: getUserMissionProgress
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID
          schema:
            type: integer
            example: 1
        - name: missionId
          in: path
          required: true
          description: Mission ID
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Successfully retrieved mission progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserMissionProgress'
              examples:
                videoNotStarted:
                  summary: Video mission not started
                  value:
                    missionId: 1
                    status: UNCOMPLETED
                    watchPositionSeconds: 0
                videoInProgress:
                  summary: Video mission in progress
                  value:
                    missionId: 1
                    status: UNCOMPLETED
                    watchPositionSeconds: 150
                videoCompleted:
                  summary: Video mission completed but not delivered
                  value:
                    missionId: 1
                    status: COMPLETED
                    watchPositionSeconds: 256
                missionDelivered:
                  summary: Mission delivered
                  value:
                    missionId: 1
                    status: DELIVERED
                    watchPositionSeconds: 256
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Invalid or missing token
                  value:
                    error: Unauthorized or invalid token
        '403':
          description: Forbidden - cannot access other user's progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                forbidden:
                  summary: Cannot access other user's progress
                  value:
                    error: Cannot access progress for other users
        '404':
          description: Mission not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Mission does not exist
                  value:
                    error: Mission not found
    put:
      tags:
        - Progress
      summary: Update user's mission progress
      description: |
        Updates the user's progress for a specific mission (upsert operation - creates if not exists).

        **Authentication:**
        - Requires valid JWT token
        - User can only update their own progress

        **Progress Tracking:**
        - For VIDEO missions:
          - Frontend calls this API every 10 seconds during video playback
          - Send watchPositionSeconds to update progress
          - Backend automatically checks if watchPositionSeconds == durationSeconds
          - When equal, mission status becomes "COMPLETED" but NOT "DELIVERED"
          - Progress can be updated multiple times (for rewatching)

        - For ARTICLE and QUESTIONNAIRE missions:
          - No progress tracking needed
          - User directly delivers the mission to mark as completed

        **Status Transitions:**
        - UNCOMPLETED → COMPLETED: When video reaches end (watchPositionSeconds == durationSeconds)
        - User must manually deliver (via deliver endpoint) to get experience points and change to DELIVERED status

        **Upsert Behavior:**
        - If progress record doesn't exist, creates new record with provided watchPositionSeconds
        - If progress record exists, updates the watchPositionSeconds

        **Note:**
        - This endpoint does NOT grant experience points
        - Experience points are only granted via deliver endpoint
      operationId: updateUserMissionProgress
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID
          schema:
            type: integer
            example: 1
        - name: missionId
          in: path
          required: true
          description: Mission ID
          schema:
            type: integer
            example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProgressRequest'
            examples:
              videoInProgress:
                summary: Update video progress to 150 seconds
                value:
                  watchPositionSeconds: 150
              videoCompleted:
                summary: Update video progress to completion (256 seconds)
                value:
                  watchPositionSeconds: 256
      responses:
        '200':
          description: Progress updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProgressUpdateResponse'
              examples:
                videoInProgress:
                  summary: 'Video progress updated (status: UNCOMPLETED)'
                  value:
                    missionId: 1
                    watchPositionSeconds: 150
                    status: UNCOMPLETED
                videoCompleted:
                  summary: 'Video progress updated (status: COMPLETED)'
                  value:
                    missionId: 1
                    watchPositionSeconds: 256
                    status: COMPLETED
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidProgress:
                  summary: Invalid watch position
                  value:
                    error: 'Invalid watch position: must be between 0 and video duration'
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Invalid or missing token
                  value:
                    error: Unauthorized or invalid token
        '403':
          description: Forbidden - cannot update other user's progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                forbidden:
                  summary: Cannot update other user's progress
                  value:
                    error: Cannot update progress for other users
        '404':
          description: Mission not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Mission does not exist
                  value:
                    error: Mission not found
  '/users/{userId}/missions/{missionId}/progress/deliver':
    post:
      tags:
        - Progress
      summary: Deliver mission for experience points
      description: |
        Deliver a completed mission to receive experience points and change status to DELIVERED.

        **Authentication:**
        - Requires valid JWT token
        - User can only deliver their own progress

        **Requirements:**
        - For VIDEO missions: Must have status COMPLETED (watched to the end)
        - For ARTICLE/QUESTIONNAIRE missions: Can be delivered directly (no progress tracking)
        - Cannot deliver if mission status is already DELIVERED
        - Each mission can only be delivered once

        **Effects:**
        - Changes progress status from COMPLETED (or UNCOMPLETED for non-video) to DELIVERED
        - Adds experience points to user (amount defined in mission rewards)
        - Updates user level based on new experience points

        **Level Calculation:**
        - Level 1: 0-199 XP
        - Level 2: 200-499 XP
        - Level 3: 500-1499 XP
        - Level 4: 1500-2999 XP
        - Level 5: 3000-4999 XP
        - Level 6: 5000-6999 XP
        - Level 7+: +2000 XP per level
        - Level 36 (max): 65000+ XP

        **Note:**
        - Experience points are only granted once per mission
        - Duplicate deliveries return 409 Conflict
      operationId: deliverMission
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID
          schema:
            type: integer
            example: 1
        - name: missionId
          in: path
          required: true
          description: Mission ID
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Mission delivered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeliverResponse'
              examples:
                success:
                  summary: Successfully delivered and gained experience
                  value:
                    message: Mission delivered successfully
                    experienceGained: 100
                    totalExperience: 1500
                    currentLevel: 4
                levelUp:
                  summary: Delivered and leveled up
                  value:
                    message: Mission delivered successfully
                    experienceGained: 100
                    totalExperience: 3000
                    currentLevel: 5
        '400':
          description: Mission not completed or invalid state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                videoNotCompleted:
                  summary: Cannot deliver incomplete video mission
                  value:
                    error: Video mission must be COMPLETED before delivery
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Invalid or missing token
                  value:
                    error: Unauthorized or invalid token
        '403':
          description: Forbidden - cannot deliver other user's progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                forbidden:
                  summary: Cannot deliver other user's progress
                  value:
                    error: Cannot deliver progress for other users
        '404':
          description: Mission not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Mission does not exist
                  value:
                    error: Mission not found
        '409':
          description: Mission already delivered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                duplicate:
                  summary: Cannot deliver twice
                  value:
                    error: Mission has already been delivered
  /users/me:
    get:
      tags:
        - Users
      summary: Get current user profile
      description: |
        Returns the current authenticated user's profile information.

        **Authentication:**
        - Requires valid JWT token

        **Response Includes:**
        - User ID
        - Username
        - Experience points (total accumulated)
        - Current level (calculated from experience)
        - User role (STUDENT, TEACHER, ADMIN)

        **Level Information:**
        - Level is calculated based on total experience points
        - Maximum level is 36 (requires 65000+ XP)
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Successfully retrieved user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
              examples:
                student:
                  summary: Student user profile
                  value:
                    id: 1
                    username: john_doe123
                    experiencePoints: 1500
                    level: 4
                    role: STUDENT
                highLevel:
                  summary: High-level student
                  value:
                    id: 2
                    username: advanced_learner
                    experiencePoints: 15000
                    level: 11
                    role: STUDENT
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Invalid or missing token
                  value:
                    error: Unauthorized or invalid token
        '404':
          description: Not Found - user profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: User not found
                  value:
                    error: User not found
  /orders:
    post:
      tags:
        - Orders
      summary: Create an order
      description: |
        Creates a new order for a journey purchase.

        **Authentication Required:**
        - User must be logged in to create an order

        **Business Logic:**
        - One order can only contain one journey (MVP scope)
        - If user has already purchased the journey: returns 409 Conflict
        - If user already has an unpaid order for this journey: returns the existing order (200 OK)
        - Order number format: `{timestamp}{userId}{randomCode}`
          - Example: `20251121011117cd5` = `2025112101` (timestamp) + `11` (userId) + `17cd5` (random code)
        - Journey price is locked at order creation time (from journeys.price)
        - Order status defaults to UNPAID
        - Order expiration time is set to created_at + 3 days
        - Orders automatically expire after 3 days if not paid (status changes to EXPIRED)

        **Next Steps:**
        - Frontend should redirect to order payment page
        - User can complete payment via POST /orders/{orderId}/pay
      operationId: createOrder
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
            examples:
              create:
                summary: Create order for a journey
                value:
                  items:
                    - journeyId: 17
                      quantity: 1
      responses:
        '200':
          description: 'User already has an unpaid order for this journey, returning existing order'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              examples:
                existing:
                  summary: Existing unpaid order returned
                  value:
                    id: 120
                    orderNumber: 20251120011117a8f
                    userId: 11
                    username: john_doe
                    status: UNPAID
                    originalPrice: 7599
                    discount: 0
                    price: 7599
                    items:
                      - journeyId: 17
                        journeyTitle: AI x BDD：規格驅動全自動開發術
                        quantity: 1
                        originalPrice: 7599
                        discount: 0
                        price: 7599
                    createdAt: 1732334400000
                    expiredAt: 1732593600000
                    paidAt: null
        '201':
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              examples:
                created:
                  summary: New order created
                  value:
                    id: 123
                    orderNumber: 20251121011117cd5
                    userId: 11
                    username: john_doe
                    status: UNPAID
                    originalPrice: 7599
                    discount: 0
                    price: 7599
                    items:
                      - journeyId: 17
                        journeyTitle: AI x BDD：規格驅動全自動開發術
                        quantity: 1
                        originalPrice: 7599
                        discount: 0
                        price: 7599
                    createdAt: 1732420800000
                    expiredAt: 1732680000000
                    paidAt: null
        '400':
          description: Bad request - invalid journey ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidJourney:
                  summary: Invalid journey ID
                  value:
                    error: Invalid journey ID
        '401':
          description: Unauthorized - user not logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: User not authenticated
                  value:
                    error: Authentication required
        '404':
          description: Journey not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Journey does not exist
                  value:
                    error: Journey not found
        '409':
          description: Conflict - user has already purchased this journey
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                alreadyPurchased:
                  summary: User already owns this journey
                  value:
                    error: 你已經購買此課程
  '/orders/{orderId}':
    get:
      tags:
        - Orders
      summary: Get order details
      description: |
        Returns detailed information about a specific order.

        **Authentication Required:**
        - User must be logged in
        - User can only view their own orders (returns 404 if trying to access another user's order)

        **Use Cases:**
        - Display order information on payment page ("完成支付" stage)
        - Display order confirmation after payment ("購買完成" stage)
        - Review order history

        **Response:**
        - Order basic information (order number, status, prices)
        - Order items (journey information)
        - Timestamps (created_at, paid_at if applicable)
      operationId: getOrderDetail
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          description: Order ID
          schema:
            type: integer
            example: 123
      responses:
        '200':
          description: Successfully retrieved order details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              examples:
                unpaid:
                  summary: Unpaid order
                  value:
                    id: 123
                    orderNumber: 20251121011117cd5
                    userId: 11
                    username: john_doe
                    status: UNPAID
                    originalPrice: 7599
                    discount: 0
                    price: 7599
                    items:
                      - journeyId: 17
                        journeyTitle: AI x BDD：規格驅動全自動開發術
                        quantity: 1
                        originalPrice: 7599
                        discount: 0
                        price: 7599
                    createdAt: 1732420800000
                    expiredAt: 1732680000000
                    paidAt: null
                paid:
                  summary: Paid order
                  value:
                    id: 123
                    orderNumber: 20251121011117cd5
                    userId: 11
                    username: john_doe
                    status: PAID
                    originalPrice: 7599
                    discount: 0
                    price: 7599
                    items:
                      - journeyId: 17
                        journeyTitle: AI x BDD：規格驅動全自動開發術
                        quantity: 1
                        originalPrice: 7599
                        discount: 0
                        price: 7599
                    createdAt: 1732420800000
                    expiredAt: null
                    paidAt: 1732507200000
                expired:
                  summary: Expired order
                  value:
                    id: 124
                    orderNumber: 20251118011117xyz
                    userId: 11
                    username: john_doe
                    status: EXPIRED
                    originalPrice: 7599
                    discount: 0
                    price: 7599
                    items:
                      - journeyId: 17
                        journeyTitle: AI x BDD：規格驅動全自動開發術
                        quantity: 1
                        originalPrice: 7599
                        discount: 0
                        price: 7599
                    createdAt: 1732161600000
                    expiredAt: 1732420800000
                    paidAt: null
        '401':
          description: Unauthorized - user not logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: User not authenticated
                  value:
                    error: Authentication required
        '404':
          description: Order not found or user does not have permission to view this order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Order does not exist or access denied
                  value:
                    error: Order not found
  '/orders/{orderId}/action/pay':
    post:
      tags:
        - Orders
      summary: Complete order payment
      description: |
        Completes payment for an order and grants journey access to the user.

        **Authentication Required:**
        - User must be logged in
        - User can only pay for their own orders

        **Business Logic:**
        - Order status must be UNPAID (EXPIRED orders cannot be paid)
        - After successful payment:
          - Order status changes to PAID
          - paid_at timestamp is set
          - User gains access to the journey (record created in user_journeys table)
        - Payment is simulated (no actual payment gateway integration in MVP)

        **Note:**
        - In MVP, clicking "立即支付" button automatically completes the purchase
        - Real payment integration can be added in future releases
      operationId: payOrder
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          description: Order ID
          schema:
            type: integer
            example: 123
      responses:
        '200':
          description: Payment completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PayOrderResponse'
              examples:
                success:
                  summary: Payment successful
                  value:
                    id: 123
                    orderNumber: 20251121011117cd5
                    status: PAID
                    price: 7599
                    paidAt: 1732507200000
                    message: 付款完成
        '401':
          description: Unauthorized - user not logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: User not authenticated
                  value:
                    error: Authentication required
        '404':
          description: Order not found or user does not have permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: Order does not exist or access denied
                  value:
                    error: Order not found
        '409':
          description: Conflict - order is already paid or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                alreadyPaid:
                  summary: Order already completed
                  value:
                    error: 訂單已付款
                expired:
                  summary: Order has expired
                  value:
                    error: 訂單已過期
  '/users/{userId}/orders':
    get:
      tags:
        - Users
      summary: Get user's order list
      description: |
        Returns a list of orders for a specific user.

        **Authentication Required:**
        - User must be logged in
        - User can only view their own orders (returns 404 if trying to access another user's orders)

        **Use Cases:**
        - Display order list in "訂單管理" section
        - Allow users to review their order history

        **Query Parameters:**
        - page: Page number for pagination (optional, default: 1)
        - limit: Items per page (optional, default: 20)

        **Response:**
        - List of all order summaries (basic order info + first journey item)
        - Pagination metadata
        - Orders are sorted by creation time (newest first)
      operationId: getUserOrders
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID
          schema:
            type: integer
            example: 11
        - name: page
          in: query
          required: false
          description: Page number (starts from 1)
          schema:
            type: integer
            minimum: 1
            default: 1
            example: 1
        - name: limit
          in: query
          required: false
          description: Number of items per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
      responses:
        '200':
          description: Successfully retrieved order list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderListResponse'
              examples:
                success:
                  summary: User order list with pagination
                  value:
                    orders:
                      - id: 125
                        orderNumber: 20251122011117f3a
                        status: UNPAID
                        price: 5999
                        items:
                          - journeyId: 18
                            journeyTitle: Web 開發實戰
                        createdAt: 1732593600000
                      - id: 123
                        orderNumber: 20251121011117cd5
                        status: PAID
                        price: 7599
                        items:
                          - journeyId: 17
                            journeyTitle: AI x BDD：規格驅動全自動開發術
                        createdAt: 1732420800000
                        paidAt: 1732507200000
                    pagination:
                      page: 1
                      limit: 20
                      total: 2
        '401':
          description: Unauthorized - user not logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: User not authenticated
                  value:
                    error: Authentication required
        '404':
          description: User not found or access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: User does not exist or access denied
                  value:
                    error: User not found
  '/users/{userId}/journeys':
    get:
      tags:
        - Users
      summary: Get user's purchased journeys
      description: |
        Returns a list of journeys that the user has purchased (has access to).

        **Authentication Required:**
        - User must be logged in
        - User can only view their own purchased journeys (returns 404 if trying to access another user's journeys)

        **Use Cases:**
        - Check if user has purchased a specific journey
        - Display user's course library
        - Verify journey access before allowing content viewing

        **Response:**
        - List of purchased journeys with basic information
        - Purchase timestamp (when payment was completed)
        - Related order number for reference

        **Note:**
        - Only includes journeys with PAID orders (UNPAID orders do not grant access)
        - Frontend can use this list to determine whether to show "繼續學習" or "立即加入課程" button
      operationId: getUserJourneys
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID
          schema:
            type: integer
            example: 11
      responses:
        '200':
          description: Successfully retrieved user's purchased journeys
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserJourneyListResponse'
              examples:
                success:
                  summary: User's purchased journey list
                  value:
                    journeys:
                      - journeyId: 17
                        journeyTitle: AI x BDD：規格驅動全自動開發術
                        journeySlug: ai-bdd-spec-driven-development
                        coverImageUrl: 'https://example.com/covers/ai-bdd.jpg'
                        teacherName: 水球潘
                        purchasedAt: 1732507200000
                        orderNumber: 20251121011117cd5
                      - journeyId: 15
                        journeyTitle: 軟體設計模式精通之旅
                        journeySlug: software-design-patterns
                        coverImageUrl: 'https://example.com/covers/design-patterns.jpg'
                        teacherName: 水球潘
                        purchasedAt: 1732334400000
                        orderNumber: 20251119011115b2c
                empty:
                  summary: User has no purchased journeys
                  value:
                    journeys: []
        '401':
          description: Unauthorized - user not logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: User not authenticated
                  value:
                    error: Authentication required
        '404':
          description: User not found or access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: User does not exist or access denied
                  value:
                    error: User not found
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token obtained from login endpoint.

        **Usage:**
        Include in Authorization header: `Authorization: Bearer <token>`

        **Token Contents:**
        - user_id: User identifier
        - username: Username
        - iat: Issued at timestamp
        - exp: Expiration timestamp (1 day from iat)

        **Security:**
        - Tokens expire in 1 day
        - Always use HTTPS in production
  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - database
      properties:
        status:
          type: string
          enum:
            - UP
            - DOWN
          description: Overall health status of the service
        database:
          type: string
          enum:
            - UP
            - DOWN
          description: Database connection health status
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: An error occurred
    RegisterRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
          pattern: '^[a-zA-Z0-9_]+$'
          description: Username (alphanumeric and underscore only)
          example: john_doe123
        password:
          type: string
          minLength: 8
          maxLength: 72
          pattern: '^[a-zA-Z0-9@$!%*?&#]+$'
          description: 'Password (alphanumeric and special characters, 8-72 characters)'
          example: SecurePass123!
    RegisterResponse:
      type: object
      required:
        - message
        - userId
      properties:
        message:
          type: string
          description: Success message
          example: Registration successful
        userId:
          type: integer
          description: Newly created user ID
          example: 1
    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          description: Username
          example: john_doe123
        password:
          type: string
          description: Password
          example: SecurePass123!
    LoginResponse:
      type: object
      required:
        - accessToken
        - user
      properties:
        accessToken:
          type: string
          description: JWT access token (expires in 1 day)
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        user:
          $ref: '#/components/schemas/UserInfo'
    UserInfo:
      type: object
      required:
        - id
        - username
        - experience
      properties:
        id:
          type: integer
          description: User ID
          example: 1
        username:
          type: string
          description: Username
          example: john_doe123
        experience:
          type: integer
          minimum: 0
          description: User experience points
          example: 0
    LogoutResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Success message
          example: Logout successful
    JourneyListItem:
      type: object
      required:
        - id
        - slug
        - title
        - description
        - coverImageUrl
        - teacherName
        - price
      properties:
        id:
          type: integer
          description: Journey ID
          example: 1
        slug:
          type: string
          description: URL-friendly identifier for the journey
          example: software-design-pattern
        title:
          type: string
          description: Journey title
          example: 軟體設計模式精通之旅
        description:
          type: string
          description: Journey description
          example: 用 C.A. 模式大大提昇系統思維能力
        coverImageUrl:
          type: string
          format: uri
          description: Cover image URL
          example: 'https://example.com/cover1.jpg'
        teacherName:
          type: string
          description: Teacher name
          example: 水球潘
        price:
          type: integer
          description: Journey price in TWD (New Taiwan Dollar)
          example: 3990
    JourneyDetail:
      type: object
      required:
        - id
        - slug
        - title
        - description
        - coverImageUrl
        - teacherName
        - price
        - chapters
      properties:
        id:
          type: integer
          description: Journey ID
          example: 1
        slug:
          type: string
          description: URL-friendly identifier for the journey
          example: software-design-pattern
        title:
          type: string
          description: Journey title
          example: 軟體設計模式精通之旅
        description:
          type: string
          description: Journey description
          example: 用 C.A. 模式大大提昇系統思維能力
        coverImageUrl:
          type: string
          format: uri
          description: Cover image URL
          example: 'https://example.com/cover1.jpg'
        teacherName:
          type: string
          description: Teacher name
          example: 水球潘
        price:
          type: integer
          description: Journey price in TWD (New Taiwan Dollar)
          example: 3990
        chapters:
          type: array
          description: List of chapters in this journey
          items:
            $ref: '#/components/schemas/Chapter'
        userStatus:
          $ref: '#/components/schemas/UserStatus'
    Chapter:
      type: object
      required:
        - id
        - title
        - orderIndex
        - missions
      properties:
        id:
          type: integer
          description: Chapter ID
          example: 1
        title:
          type: string
          description: Chapter title
          example: 課程介紹
        orderIndex:
          type: integer
          description: Chapter order index
          example: 1
        missions:
          type: array
          description: List of missions in this chapter
          items:
            $ref: '#/components/schemas/MissionSummary'
    MissionSummary:
      type: object
      required:
        - id
        - type
        - title
        - accessLevel
        - orderIndex
      properties:
        id:
          type: integer
          description: Mission ID
          example: 1
        type:
          type: string
          enum:
            - VIDEO
            - ARTICLE
            - QUESTIONNAIRE
          description: 'Mission type (video, article, or questionnaire)'
          example: VIDEO
        title:
          type: string
          description: Mission title
          example: 這門課手把手帶你成為架構設計的高手
        accessLevel:
          type: string
          enum:
            - PUBLIC
            - AUTHENTICATED
            - PURCHASED
          description: |
            Mission access level:
            - PUBLIC: Can be viewed without authentication
            - AUTHENTICATED: Requires login to view
            - PURCHASED: Requires journey purchase to view
          example: PUBLIC
        orderIndex:
          type: integer
          description: Mission order index within the chapter
          example: 1
        status:
          type: string
          enum:
            - UNCOMPLETED
            - COMPLETED
            - DELIVERED
          description: |
            Mission completion status for the authenticated user.
            - UNCOMPLETED: Mission in progress or not started
            - COMPLETED: Mission completed but not delivered yet
            - DELIVERED: Mission delivered and rewards received

            Note: This field is only included when the request is authenticated.
            For unauthenticated requests, this field will be null or omitted.
          example: UNCOMPLETED
          nullable: true
    MissionDetail:
      type: object
      required:
        - id
        - chapterId
        - journeyId
        - type
        - title
        - description
        - isFreePreview
        - createdAt
        - reward
        - content
      properties:
        id:
          type: integer
          description: Mission ID
          example: 1
        chapterId:
          type: integer
          description: Chapter ID this mission belongs to
          example: 8
        journeyId:
          type: integer
          description: Journey ID (derived from chapter)
          example: 1
        type:
          type: string
          enum:
            - VIDEO
            - ARTICLE
            - QUESTIONNAIRE
          description: Mission type
          example: VIDEO
        title:
          type: string
          description: Mission title
          example: 課程介紹：這門課手把手帶你成為架構設計的高手
        description:
          type: string
          description: Detailed description of the mission
          example: 思維升級：Christopher Alexander 模式六大要素及模式語言
        isFreePreview:
          type: boolean
          description: Whether this mission is free to preview
          example: true
        createdAt:
          type: integer
          format: int64
          description: Creation timestamp in milliseconds
          example: 1733294001561
        videoLength:
          type: string
          description: 'Video duration in MM:SS format (VIDEO type only, derived from content)'
          example: '04:16'
        reward:
          $ref: '#/components/schemas/MissionReward'
        content:
          type: array
          description: Mission content array (can have multiple items)
          items:
            $ref: '#/components/schemas/MissionContent'
    MissionReward:
      type: object
      required:
        - exp
      properties:
        exp:
          type: integer
          description: Experience points reward
          example: 100
    MissionContent:
      type: object
      required:
        - type
        - url
        - id
      properties:
        id:
          type: integer
          description: Content item ID
          example: 0
        type:
          type: string
          enum:
            - video
            - article
            - form
          description: Content type (lowercase)
          example: video
        url:
          type: string
          format: uri
          description: Content URL
          example: 'https://cdn.waterballsa.tw/software-design-pattern/videos/c8m1-0/c8m1-0.m3u8'
        durationSeconds:
          type: integer
          description: Video duration in seconds (VIDEO type only)
          example: 256
    UpdateProgressRequest:
      type: object
      required:
        - watchPositionSeconds
      properties:
        watchPositionSeconds:
          type: integer
          description: Current watch position in seconds (for VIDEO missions)
          example: 150
          minimum: 0
    ProgressUpdateResponse:
      type: object
      required:
        - missionId
        - status
        - watchPositionSeconds
      properties:
        missionId:
          type: integer
          description: Mission ID
          example: 1
        watchPositionSeconds:
          type: integer
          description: Updated watch position (for VIDEO missions)
          example: 150
        status:
          type: string
          enum:
            - UNCOMPLETED
            - COMPLETED
            - DELIVERED
          description: Current mission status after update
          example: UNCOMPLETED
    DeliverResponse:
      type: object
      required:
        - message
        - experienceGained
        - totalExperience
        - currentLevel
      properties:
        message:
          type: string
          description: Success message
          example: Mission delivered successfully
        experienceGained:
          type: integer
          description: Experience points gained from this delivery
          example: 100
        totalExperience:
          type: integer
          description: User's total experience points after delivery
          example: 1500
        currentLevel:
          type: integer
          description: User's current level after delivery
          example: 4
    UserMissionProgress:
      type: object
      required:
        - missionId
        - status
        - watchPositionSeconds
      properties:
        missionId:
          type: integer
          description: Mission ID
          example: 1
        status:
          type: string
          enum:
            - UNCOMPLETED
            - COMPLETED
            - DELIVERED
          description: Mission status
          example: COMPLETED
        watchPositionSeconds:
          type: integer
          description: Current watch position in seconds (for VIDEO missions)
          example: 256
    UserProfile:
      type: object
      required:
        - id
        - username
        - experiencePoints
        - level
        - role
      properties:
        id:
          type: integer
          description: User ID
          example: 1
        username:
          type: string
          description: Username
          example: john_doe123
        experiencePoints:
          type: integer
          minimum: 0
          description: Total accumulated experience points
          example: 1500
        level:
          type: integer
          minimum: 1
          maximum: 36
          description: Current level (1-36)
          example: 4
        role:
          type: string
          enum:
            - STUDENT
            - TEACHER
            - ADMIN
          description: User role
          example: STUDENT
    CreateOrderRequest:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          description: List of items to purchase
          minItems: 1
          items:
            type: object
            required:
              - journeyId
              - quantity
            properties:
              journeyId:
                type: integer
                description: ID of the journey to purchase
                example: 17
              quantity:
                type: integer
                description: Quantity to purchase
                minimum: 1
                default: 1
                example: 1
    OrderResponse:
      type: object
      required:
        - id
        - orderNumber
        - userId
        - username
        - status
        - originalPrice
        - discount
        - price
        - items
        - createdAt
      properties:
        id:
          type: integer
          description: Order ID
          example: 123
        orderNumber:
          type: string
          description: |
            Unique order number with format: {timestamp}{userId}{randomCode}
            Example: 20251121011117cd5 = 2025112101 (timestamp) + 11 (userId) + 17cd5 (random)
          example: 20251121011117cd5
        userId:
          type: integer
          description: User ID who created this order
          example: 11
        username:
          type: string
          description: Username of the order owner
          example: john_doe
        status:
          type: string
          enum:
            - UNPAID
            - PAID
            - EXPIRED
          description: |
            Order status:
            - UNPAID: Order created but not yet paid
            - PAID: Payment completed, user has journey access
            - EXPIRED: Order expired after 3 days without payment, cannot be paid
          example: UNPAID
        originalPrice:
          type: number
          format: decimal
          description: Total original price (sum of all item original prices)
          example: 7599
        discount:
          type: number
          format: decimal
          description: Total discount amount
          example: 0
        price:
          type: number
          format: decimal
          description: Final amount to pay (originalPrice - discount)
          example: 7599
        items:
          type: array
          description: List of order items (journeys to purchase)
          items:
            $ref: '#/components/schemas/OrderItem'
        createdAt:
          type: integer
          format: int64
          description: Order creation timestamp (milliseconds since epoch)
          example: 1732420800000
        expiredAt:
          type: integer
          format: int64
          description: 'Order expiration timestamp (created_at + 3 days, null if already paid)'
          example: 1732680000000
          nullable: true
        paidAt:
          type: integer
          format: int64
          description: Payment completion timestamp (null if not paid yet)
          example: 1732507200000
          nullable: true
    OrderItem:
      type: object
      required:
        - journeyId
        - journeyTitle
        - quantity
        - originalPrice
        - discount
        - price
      properties:
        journeyId:
          type: integer
          description: Journey ID
          example: 17
        journeyTitle:
          type: string
          description: Journey title (snapshot at order creation time)
          example: AI x BDD：規格驅動全自動開發術
        quantity:
          type: integer
          description: Quantity of this journey (always 1 in MVP)
          example: 1
        originalPrice:
          type: number
          format: decimal
          description: Journey price at order creation time (locked price)
          example: 7599
        discount:
          type: number
          format: decimal
          description: Discount applied to this item
          example: 0
        price:
          type: number
          format: decimal
          description: Final price for this item (originalPrice - discount)
          example: 7599
    PayOrderResponse:
      type: object
      required:
        - id
        - orderNumber
        - status
        - price
        - paidAt
        - message
      properties:
        id:
          type: integer
          description: Order ID
          example: 123
        orderNumber:
          type: string
          description: Order number
          example: 20251121011117cd5
        status:
          type: string
          enum:
            - PAID
          description: Order status (always PAID after successful payment)
          example: PAID
        price:
          type: number
          format: decimal
          description: Amount paid
          example: 7599
        paidAt:
          type: integer
          format: int64
          description: Payment completion timestamp (milliseconds since epoch)
          example: 1732507200000
        message:
          type: string
          description: Success message
          example: 付款完成
    OrderListResponse:
      type: object
      required:
        - orders
        - pagination
      properties:
        orders:
          type: array
          description: List of order summaries
          items:
            $ref: '#/components/schemas/OrderSummary'
        pagination:
          $ref: '#/components/schemas/Pagination'
    OrderSummary:
      type: object
      required:
        - id
        - orderNumber
        - status
        - price
        - items
        - createdAt
      properties:
        id:
          type: integer
          description: Order ID
          example: 123
        orderNumber:
          type: string
          description: Order number
          example: 20251121011117cd5
        status:
          type: string
          enum:
            - UNPAID
            - PAID
            - EXPIRED
          description: Order status
          example: UNPAID
        price:
          type: number
          format: decimal
          description: Final amount to pay
          example: 7599
        items:
          type: array
          description: Simplified order items (for list display)
          items:
            $ref: '#/components/schemas/OrderItemSummary'
        createdAt:
          type: integer
          format: int64
          description: Order creation timestamp
          example: 1732420800000
        expiredAt:
          type: integer
          format: int64
          description: 'Order expiration timestamp (created_at + 3 days, null if already paid)'
          example: 1732680000000
          nullable: true
        paidAt:
          type: integer
          format: int64
          description: Payment completion timestamp (null if unpaid)
          example: 1732507200000
          nullable: true
    OrderItemSummary:
      type: object
      required:
        - journeyId
        - journeyTitle
      properties:
        journeyId:
          type: integer
          description: Journey ID
          example: 17
        journeyTitle:
          type: string
          description: Journey title
          example: AI x BDD：規格驅動全自動開發術
    Pagination:
      type: object
      required:
        - page
        - limit
        - total
      properties:
        page:
          type: integer
          description: Current page number (starts from 1)
          example: 1
        limit:
          type: integer
          description: Number of items per page
          example: 20
        total:
          type: integer
          description: Total number of items
          example: 5
    UserJourneyListResponse:
      type: object
      required:
        - journeys
      properties:
        journeys:
          type: array
          description: List of journeys the user has purchased
          items:
            $ref: '#/components/schemas/UserJourneyItem'
    UserJourneyItem:
      type: object
      required:
        - journeyId
        - journeyTitle
        - journeySlug
        - coverImageUrl
        - teacherName
        - purchasedAt
        - orderNumber
      properties:
        journeyId:
          type: integer
          description: Journey ID
          example: 17
        journeyTitle:
          type: string
          description: Journey title
          example: AI x BDD：規格驅動全自動開發術
        journeySlug:
          type: string
          description: URL-friendly journey identifier
          example: ai-bdd-spec-driven-development
        coverImageUrl:
          type: string
          format: uri
          description: Journey cover image URL
          example: 'https://example.com/covers/ai-bdd.jpg'
        teacherName:
          type: string
          description: Teacher name
          example: 水球潘
        purchasedAt:
          type: integer
          format: int64
          description: Purchase timestamp - when the order was paid (milliseconds since epoch)
          example: 1732507200000
        orderNumber:
          type: string
          description: Order number that granted access to this journey
          example: 20251121011117cd5
    UserStatus:
      type: object
      required:
        - hasPurchased
        - hasUnpaidOrder
      properties:
        hasPurchased:
          type: boolean
          description: |
            Whether the user has purchased this journey.
            - true: User owns this journey (has PAID order)
            - false: User does not own this journey
          example: true
        hasUnpaidOrder:
          type: boolean
          description: |
            Whether the user has an unpaid order for this journey.
            - true: User has created an order but not yet paid
            - false: User has no unpaid order
          example: false
        unpaidOrderId:
          type: integer
          description: |
            The ID of the unpaid order for this journey (if hasUnpaidOrder is true).
            Frontend can use this to redirect user to the payment page.
          example: 123
          nullable: true
      nullable: true
      description: |
        User's purchase status for this journey. Only included when user is authenticated.
        For unauthenticated requests, this field will be null.
