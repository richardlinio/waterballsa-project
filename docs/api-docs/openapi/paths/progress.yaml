detail:
  get:
    tags:
      - Progress
    summary: Get user's mission progress
    description: |
      Returns the user's progress for a specific mission.

      **Authentication:**
      - Requires valid JWT token

      **Response Includes:**
      - Mission ID
      - Current status (UNCOMPLETED, COMPLETED, DELIVERED)
      - Watch position in seconds (for VIDEO missions)

      **Status Meanings:**
      - UNCOMPLETED: Mission in progress or not started
      - COMPLETED: Mission completed but not delivered yet
      - DELIVERED: Mission delivered and rewards received

      **Note:**
      - For missions without progress record, returns default UNCOMPLETED status with watchPositionSeconds: 0
    operationId: getUserMissionProgress
    security:
      - bearerAuth: []
    parameters:
      - name: userId
        in: path
        required: true
        description: User ID
        schema:
          type: integer
          example: 1
      - name: missionId
        in: path
        required: true
        description: Mission ID
        schema:
          type: integer
          example: 1
    responses:
      '200':
        description: Successfully retrieved mission progress
        content:
          application/json:
            schema:
              $ref: '../schemas/missions.yaml#/UserMissionProgress'
            examples:
              videoNotStarted:
                summary: Video mission not started
                value:
                  missionId: 1
                  status: 'UNCOMPLETED'
                  watchPositionSeconds: 0
              videoInProgress:
                summary: Video mission in progress
                value:
                  missionId: 1
                  status: 'UNCOMPLETED'
                  watchPositionSeconds: 150
              videoCompleted:
                summary: Video mission completed but not delivered
                value:
                  missionId: 1
                  status: 'COMPLETED'
                  watchPositionSeconds: 256
              missionDelivered:
                summary: Mission delivered
                value:
                  missionId: 1
                  status: 'DELIVERED'
                  watchPositionSeconds: 256
      '401':
        description: Unauthorized - invalid or missing token
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: Invalid or missing token
                value:
                  error: 'Unauthorized or invalid token'
      '403':
        description: Forbidden - cannot access other user's progress
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              forbidden:
                summary: Cannot access other user's progress
                value:
                  error: 'Cannot access progress for other users'
      '404':
        description: Mission not found
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: Mission does not exist
                value:
                  error: 'Mission not found'

  put:
    tags:
      - Progress
    summary: Update user's mission progress
    description: |
      Updates the user's progress for a specific mission (upsert operation - creates if not exists).

      **Authentication:**
      - Requires valid JWT token
      - User can only update their own progress

      **Progress Tracking:**
      - For VIDEO missions:
        - Frontend calls this API every 10 seconds during video playback
        - Send watchPositionSeconds to update progress
        - Backend automatically checks if watchPositionSeconds == durationSeconds
        - When equal, mission status becomes "COMPLETED" but NOT "DELIVERED"
        - Progress can be updated multiple times (for rewatching)

      - For ARTICLE and QUESTIONNAIRE missions:
        - No progress tracking needed
        - User directly delivers the mission to mark as completed

      **Status Transitions:**
      - UNCOMPLETED â†’ COMPLETED: When video reaches end (watchPositionSeconds == durationSeconds)
      - User must manually deliver (via deliver endpoint) to get experience points and change to DELIVERED status

      **Upsert Behavior:**
      - If progress record doesn't exist, creates new record with provided watchPositionSeconds
      - If progress record exists, updates the watchPositionSeconds

      **Note:**
      - This endpoint does NOT grant experience points
      - Experience points are only granted via deliver endpoint
    operationId: updateUserMissionProgress
    security:
      - bearerAuth: []
    parameters:
      - name: userId
        in: path
        required: true
        description: User ID
        schema:
          type: integer
          example: 1
      - name: missionId
        in: path
        required: true
        description: Mission ID
        schema:
          type: integer
          example: 1
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../schemas/missions.yaml#/UpdateProgressRequest'
          examples:
            videoInProgress:
              summary: Update video progress to 150 seconds
              value:
                watchPositionSeconds: 150
            videoCompleted:
              summary: Update video progress to completion (256 seconds)
              value:
                watchPositionSeconds: 256
    responses:
      '200':
        description: Progress updated successfully
        content:
          application/json:
            schema:
              $ref: '../schemas/missions.yaml#/ProgressUpdateResponse'
            examples:
              videoInProgress:
                summary: 'Video progress updated (status: UNCOMPLETED)'
                value:
                  missionId: 1
                  watchPositionSeconds: 150
                  status: 'UNCOMPLETED'
              videoCompleted:
                summary: 'Video progress updated (status: COMPLETED)'
                value:
                  missionId: 1
                  watchPositionSeconds: 256
                  status: 'COMPLETED'
      '400':
        description: Invalid request data
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              invalidProgress:
                summary: Invalid watch position
                value:
                  error: 'Invalid watch position: must be between 0 and video duration'
      '401':
        description: Unauthorized - invalid or missing token
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: Invalid or missing token
                value:
                  error: 'Unauthorized or invalid token'
      '403':
        description: Forbidden - cannot update other user's progress
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              forbidden:
                summary: Cannot update other user's progress
                value:
                  error: 'Cannot update progress for other users'
      '404':
        description: Mission not found
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: Mission does not exist
                value:
                  error: 'Mission not found'

deliver:
  post:
    tags:
      - Progress
    summary: Deliver mission for experience points
    description: |
      Deliver a completed mission to receive experience points and change status to DELIVERED.

      **Authentication:**
      - Requires valid JWT token
      - User can only deliver their own progress

      **Requirements:**
      - For VIDEO missions: Must have status COMPLETED (watched to the end)
      - For ARTICLE/QUESTIONNAIRE missions: Can be delivered directly (no progress tracking)
      - Cannot deliver if mission status is already DELIVERED
      - Each mission can only be delivered once

      **Effects:**
      - Changes progress status from COMPLETED (or UNCOMPLETED for non-video) to DELIVERED
      - Adds experience points to user (amount defined in mission rewards)
      - Updates user level based on new experience points

      **Level Calculation:**
      - Level 1: 0-199 XP
      - Level 2: 200-499 XP
      - Level 3: 500-1499 XP
      - Level 4: 1500-2999 XP
      - Level 5: 3000-4999 XP
      - Level 6: 5000-6999 XP
      - Level 7+: +2000 XP per level
      - Level 36 (max): 65000+ XP

      **Note:**
      - Experience points are only granted once per mission
      - Duplicate deliveries return 409 Conflict
    operationId: deliverMission
    security:
      - bearerAuth: []
    parameters:
      - name: userId
        in: path
        required: true
        description: User ID
        schema:
          type: integer
          example: 1
      - name: missionId
        in: path
        required: true
        description: Mission ID
        schema:
          type: integer
          example: 1
    responses:
      '200':
        description: Mission delivered successfully
        content:
          application/json:
            schema:
              $ref: '../schemas/missions.yaml#/DeliverResponse'
            examples:
              success:
                summary: Successfully delivered and gained experience
                value:
                  message: 'Mission delivered successfully'
                  experienceGained: 100
                  totalExperience: 1500
                  currentLevel: 4
              levelUp:
                summary: Delivered and leveled up
                value:
                  message: 'Mission delivered successfully'
                  experienceGained: 100
                  totalExperience: 3000
                  currentLevel: 5
      '400':
        description: Mission not completed or invalid state
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              videoNotCompleted:
                summary: Cannot deliver incomplete video mission
                value:
                  error: 'Video mission must be COMPLETED before delivery'
      '401':
        description: Unauthorized - invalid or missing token
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: Invalid or missing token
                value:
                  error: 'Unauthorized or invalid token'
      '403':
        description: Forbidden - cannot deliver other user's progress
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              forbidden:
                summary: Cannot deliver other user's progress
                value:
                  error: 'Cannot deliver progress for other users'
      '404':
        description: Mission not found
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: Mission does not exist
                value:
                  error: 'Mission not found'
      '409':
        description: Mission already delivered
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              duplicate:
                summary: Cannot deliver twice
                value:
                  error: 'Mission has already been delivered'
