detail:
  get:
    tags:
      - Progress
    summary: 取得使用者的任務進度
    description: |
      回傳使用者特定任務的進度。

      **認證：**
      - 需要有效的 JWT token

      **回應包含：**
      - 任務 ID
      - 目前狀態（UNCOMPLETED、COMPLETED、DELIVERED）
      - 觀看位置（秒數）（針對影片任務）

      **狀態含義：**
      - UNCOMPLETED：任務進行中或尚未開始
      - COMPLETED：任務已完成但尚未交付
      - DELIVERED：任務已交付且獎勵已領取

      **注意：**
      - 對於沒有進度記錄的任務，回傳預設的 UNCOMPLETED 狀態，watchPositionSeconds 為 0
    operationId: getUserMissionProgress
    security:
      - bearerAuth: []
    parameters:
      - name: userId
        in: path
        required: true
        description: 使用者 ID
        schema:
          type: integer
          example: 1
      - name: missionId
        in: path
        required: true
        description: 任務 ID
        schema:
          type: integer
          example: 1
    responses:
      '200':
        description: 成功取得任務進度
        content:
          application/json:
            schema:
              $ref: '../schemas/missions.yaml#/UserMissionProgress'
            examples:
              videoNotStarted:
                summary: 影片任務尚未開始
                value:
                  missionId: 1
                  status: 'UNCOMPLETED'
                  watchPositionSeconds: 0
              videoInProgress:
                summary: 影片任務進行中
                value:
                  missionId: 1
                  status: 'UNCOMPLETED'
                  watchPositionSeconds: 150
              videoCompleted:
                summary: 影片任務已完成但尚未交付
                value:
                  missionId: 1
                  status: 'COMPLETED'
                  watchPositionSeconds: 256
              missionDelivered:
                summary: 任務已交付
                value:
                  missionId: 1
                  status: 'DELIVERED'
                  watchPositionSeconds: 256
      '401':
        description: 未授權 - 無效或遺失的 token
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: 無效或遺失的 token
                value:
                  error: '未授權或無效的 token'
      '403':
        description: 禁止 - 無法存取其他使用者的進度
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              forbidden:
                summary: 無法存取其他使用者的進度
                value:
                  error: '無法存取其他使用者的進度'
      '404':
        description: 找不到任務
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: 任務不存在
                value:
                  error: '找不到任務'

  put:
    tags:
      - Progress
    summary: 更新使用者的任務進度
    description: |
      更新使用者特定任務的進度（upsert 操作 - 不存在則建立）。

      **認證：**
      - 需要有效的 JWT token
      - 使用者只能更新自己的進度

      **進度追蹤：**
      - 針對影片任務：
        - 前端在影片播放期間每 10 秒呼叫此 API
        - 傳送 watchPositionSeconds 來更新進度
        - 後端自動檢查 watchPositionSeconds == durationSeconds
        - 當相等時，任務狀態變為「COMPLETED」但不是「DELIVERED」
        - 進度可以多次更新（用於重新觀看）

      - 針對文章和問卷任務：
        - 不需要進度追蹤
        - 使用者直接交付任務以標記為完成

      **狀態轉換：**
      - UNCOMPLETED → COMPLETED：當影片播放到結尾時（watchPositionSeconds == durationSeconds）
      - 使用者必須手動交付（透過 deliver 端點）以獲得經驗值並變更為 DELIVERED 狀態

      **Upsert 行為：**
      - 如果進度記錄不存在，建立新記錄並使用提供的 watchPositionSeconds
      - 如果進度記錄存在，更新 watchPositionSeconds

      **注意：**
      - 此端點不授予經驗值
      - 經驗值僅透過 deliver 端點授予
    operationId: updateUserMissionProgress
    security:
      - bearerAuth: []
    parameters:
      - name: userId
        in: path
        required: true
        description: 使用者 ID
        schema:
          type: integer
          example: 1
      - name: missionId
        in: path
        required: true
        description: 任務 ID
        schema:
          type: integer
          example: 1
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../schemas/missions.yaml#/UpdateProgressRequest'
          examples:
            videoInProgress:
              summary: 更新影片進度至 150 秒
              value:
                watchPositionSeconds: 150
            videoCompleted:
              summary: 更新影片進度至完成（256 秒）
              value:
                watchPositionSeconds: 256
    responses:
      '200':
        description: 進度更新成功
        content:
          application/json:
            schema:
              $ref: '../schemas/missions.yaml#/ProgressUpdateResponse'
            examples:
              videoInProgress:
                summary: 影片進度已更新（狀態：UNCOMPLETED）
                value:
                  missionId: 1
                  watchPositionSeconds: 150
                  status: 'UNCOMPLETED'
              videoCompleted:
                summary: 影片進度已更新（狀態：COMPLETED）
                value:
                  missionId: 1
                  watchPositionSeconds: 256
                  status: 'COMPLETED'
      '400':
        description: 無效的請求資料
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              invalidProgress:
                summary: 無效的觀看位置
                value:
                  error: '無效的觀看位置：必須介於 0 和影片長度之間'
      '401':
        description: 未授權 - 無效或遺失的 token
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: 無效或遺失的 token
                value:
                  error: '未授權或無效的 token'
      '403':
        description: 禁止 - 無法更新其他使用者的進度
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              forbidden:
                summary: 無法更新其他使用者的進度
                value:
                  error: '無法更新其他使用者的進度'
      '404':
        description: 找不到任務
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: 任務不存在
                value:
                  error: '找不到任務'

deliver:
  post:
    tags:
      - Progress
    summary: 交付任務以獲得經驗值
    description: |
      交付已完成的任務以獲得經驗值並將狀態變更為 DELIVERED。

      **認證：**
      - 需要有效的 JWT token
      - 使用者只能交付自己的進度

      **要求：**
      - 針對影片任務：必須具有 COMPLETED 狀態（已觀看至結尾）
      - 針對文章/問卷任務：可以直接交付（無需進度追蹤）
      - 如果任務狀態已經是 DELIVERED 則無法交付
      - 每個任務只能交付一次

      **效果：**
      - 將進度狀態從 COMPLETED（或非影片任務的 UNCOMPLETED）變更為 DELIVERED
      - 將經驗值新增至使用者（數量定義於任務獎勵中）
      - 根據新的經驗值更新使用者等級

      **等級計算：**
      - 等級 1：0-199 XP
      - 等級 2：200-499 XP
      - 等級 3：500-1499 XP
      - 等級 4：1500-2999 XP
      - 等級 5：3000-4999 XP
      - 等級 6：5000-6999 XP
      - 等級 7+：每級 +2000 XP
      - 等級 36（最高）：65000+ XP

      **注意：**
      - 經驗值每個任務僅授予一次
      - 重複交付回傳 409 Conflict
    operationId: deliverMission
    security:
      - bearerAuth: []
    parameters:
      - name: userId
        in: path
        required: true
        description: 使用者 ID
        schema:
          type: integer
          example: 1
      - name: missionId
        in: path
        required: true
        description: 任務 ID
        schema:
          type: integer
          example: 1
    responses:
      '200':
        description: 任務交付成功
        content:
          application/json:
            schema:
              $ref: '../schemas/missions.yaml#/DeliverResponse'
            examples:
              success:
                summary: 成功交付並獲得經驗值
                value:
                  message: '任務交付成功'
                  experienceGained: 100
                  totalExperience: 1500
                  currentLevel: 4
              levelUp:
                summary: 交付並升級
                value:
                  message: '任務交付成功'
                  experienceGained: 100
                  totalExperience: 3000
                  currentLevel: 5
      '400':
        description: 任務未完成或狀態無效
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              videoNotCompleted:
                summary: 無法交付未完成的影片任務
                value:
                  error: '影片任務必須為 COMPLETED 狀態才能交付'
      '401':
        description: 未授權 - 無效或遺失的 token
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: 無效或遺失的 token
                value:
                  error: '未授權或無效的 token'
      '403':
        description: 禁止 - 無法交付其他使用者的進度
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              forbidden:
                summary: 無法交付其他使用者的進度
                value:
                  error: '無法交付其他使用者的進度'
      '404':
        description: 找不到任務
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: 任務不存在
                value:
                  error: '找不到任務'
      '409':
        description: 任務已交付
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              duplicate:
                summary: 無法交付兩次
                value:
                  error: '任務已經交付過了'
