create:
  post:
    tags:
      - Orders
    summary: Create an order
    description: |
      Creates a new order for a journey purchase.

      **Authentication Required:**
      - User must be logged in to create an order

      **Business Logic:**
      - One order can only contain one journey (MVP scope)
      - If user has already purchased the journey: returns 409 Conflict
      - If user already has an unpaid order for this journey: returns the existing order (200 OK)
      - Order number format: `{timestamp}{userId}{randomCode}`
        - Example: `20251121011117cd5` = `2025112101` (timestamp) + `11` (userId) + `17cd5` (random code)
      - Journey price is locked at order creation time (from journeys.price)
      - Order status defaults to UNPAID
      - Order expiration time is set to created_at + 3 days
      - Orders automatically expire after 3 days if not paid (status changes to EXPIRED)

      **Next Steps:**
      - Frontend should redirect to order payment page
      - User can complete payment via POST /orders/{orderId}/pay
    operationId: createOrder
    security:
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../schemas/orders.yaml#/CreateOrderRequest'
          examples:
            create:
              summary: Create order for a journey
              value:
                items:
                  - journeyId: 17
                    quantity: 1
    responses:
      '201':
        description: Order created successfully
        content:
          application/json:
            schema:
              $ref: '../schemas/orders.yaml#/OrderResponse'
            examples:
              created:
                summary: New order created
                value:
                  id: 123
                  orderNumber: '20251121011117cd5'
                  userId: 11
                  username: 'john_doe'
                  status: 'UNPAID'
                  originalPrice: 7599.00
                  discount: 0.00
                  price: 7599.00
                  items:
                    - journeyId: 17
                      journeyTitle: 'AI x BDD：規格驅動全自動開發術'
                      quantity: 1
                      originalPrice: 7599.00
                      discount: 0.00
                      price: 7599.00
                  createdAt: 1732420800000
                  expiredAt: 1732680000000
                  paidAt: null
      '200':
        description: User already has an unpaid order for this journey, returning existing order
        content:
          application/json:
            schema:
              $ref: '../schemas/orders.yaml#/OrderResponse'
            examples:
              existing:
                summary: Existing unpaid order returned
                value:
                  id: 120
                  orderNumber: '20251120011117a8f'
                  userId: 11
                  username: 'john_doe'
                  status: 'UNPAID'
                  originalPrice: 7599.00
                  discount: 0.00
                  price: 7599.00
                  items:
                    - journeyId: 17
                      journeyTitle: 'AI x BDD：規格驅動全自動開發術'
                      quantity: 1
                      originalPrice: 7599.00
                      discount: 0.00
                      price: 7599.00
                  createdAt: 1732334400000
                  expiredAt: 1732593600000
                  paidAt: null
      '400':
        description: Bad request - invalid journey ID
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              invalidJourney:
                summary: Invalid journey ID
                value:
                  error: 'Invalid journey ID'
      '401':
        description: Unauthorized - user not logged in
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: User not authenticated
                value:
                  error: 'Authentication required'
      '404':
        description: Journey not found
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: Journey does not exist
                value:
                  error: 'Journey not found'
      '409':
        description: Conflict - user has already purchased this journey
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              alreadyPurchased:
                summary: User already owns this journey
                value:
                  error: '你已經購買此課程'

detail:
  get:
    tags:
      - Orders
    summary: Get order details
    description: |
      Returns detailed information about a specific order.

      **Authentication Required:**
      - User must be logged in
      - User can only view their own orders (returns 404 if trying to access another user's order)

      **Use Cases:**
      - Display order information on payment page ("完成支付" stage)
      - Display order confirmation after payment ("購買完成" stage)
      - Review order history

      **Response:**
      - Order basic information (order number, status, prices)
      - Order items (journey information)
      - Timestamps (created_at, paid_at if applicable)
    operationId: getOrderDetail
    security:
      - bearerAuth: []
    parameters:
      - name: orderId
        in: path
        required: true
        description: Order ID
        schema:
          type: integer
          example: 123
    responses:
      '200':
        description: Successfully retrieved order details
        content:
          application/json:
            schema:
              $ref: '../schemas/orders.yaml#/OrderResponse'
            examples:
              unpaid:
                summary: Unpaid order
                value:
                  id: 123
                  orderNumber: '20251121011117cd5'
                  userId: 11
                  username: 'john_doe'
                  status: 'UNPAID'
                  originalPrice: 7599.00
                  discount: 0.00
                  price: 7599.00
                  items:
                    - journeyId: 17
                      journeyTitle: 'AI x BDD：規格驅動全自動開發術'
                      quantity: 1
                      originalPrice: 7599.00
                      discount: 0.00
                      price: 7599.00
                  createdAt: 1732420800000
                  expiredAt: 1732680000000
                  paidAt: null
              paid:
                summary: Paid order
                value:
                  id: 123
                  orderNumber: '20251121011117cd5'
                  userId: 11
                  username: 'john_doe'
                  status: 'PAID'
                  originalPrice: 7599.00
                  discount: 0.00
                  price: 7599.00
                  items:
                    - journeyId: 17
                      journeyTitle: 'AI x BDD：規格驅動全自動開發術'
                      quantity: 1
                      originalPrice: 7599.00
                      discount: 0.00
                      price: 7599.00
                  createdAt: 1732420800000
                  expiredAt: null
                  paidAt: 1732507200000
              expired:
                summary: Expired order
                value:
                  id: 124
                  orderNumber: '20251118011117xyz'
                  userId: 11
                  username: 'john_doe'
                  status: 'EXPIRED'
                  originalPrice: 7599.00
                  discount: 0.00
                  price: 7599.00
                  items:
                    - journeyId: 17
                      journeyTitle: 'AI x BDD：規格驅動全自動開發術'
                      quantity: 1
                      originalPrice: 7599.00
                      discount: 0.00
                      price: 7599.00
                  createdAt: 1732161600000
                  expiredAt: 1732420800000
                  paidAt: null
      '401':
        description: Unauthorized - user not logged in
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: User not authenticated
                value:
                  error: 'Authentication required'
      '404':
        description: Order not found or user does not have permission to view this order
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: Order does not exist or access denied
                value:
                  error: 'Order not found'

pay:
  post:
    tags:
      - Orders
    summary: Complete order payment
    description: |
      Completes payment for an order and grants journey access to the user.

      **Authentication Required:**
      - User must be logged in
      - User can only pay for their own orders

      **Business Logic:**
      - Order status must be UNPAID (EXPIRED orders cannot be paid)
      - After successful payment:
        - Order status changes to PAID
        - paid_at timestamp is set
        - User gains access to the journey (record created in user_journeys table)
      - Payment is simulated (no actual payment gateway integration in MVP)

      **Note:**
      - In MVP, clicking "立即支付" button automatically completes the purchase
      - Real payment integration can be added in future releases
    operationId: payOrder
    security:
      - bearerAuth: []
    parameters:
      - name: orderId
        in: path
        required: true
        description: Order ID
        schema:
          type: integer
          example: 123
    responses:
      '200':
        description: Payment completed successfully
        content:
          application/json:
            schema:
              $ref: '../schemas/orders.yaml#/PayOrderResponse'
            examples:
              success:
                summary: Payment successful
                value:
                  id: 123
                  orderNumber: '20251121011117cd5'
                  status: 'PAID'
                  price: 7599.00
                  paidAt: 1732507200000
                  message: '付款完成'
      '401':
        description: Unauthorized - user not logged in
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: User not authenticated
                value:
                  error: 'Authentication required'
      '404':
        description: Order not found or user does not have permission
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: Order does not exist or access denied
                value:
                  error: 'Order not found'
      '409':
        description: Conflict - order is already paid or expired
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              alreadyPaid:
                summary: Order already completed
                value:
                  error: '訂單已付款'
              expired:
                summary: Order has expired
                value:
                  error: '訂單已過期'
