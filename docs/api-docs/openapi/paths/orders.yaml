create:
  post:
    tags:
      - Orders
    summary: 建立訂單
    description: |
      為旅程購買建立新訂單。

      **需要認證：**
      - 使用者必須已登入才能建立訂單

      **業務邏輯：**
      - 一個訂單只能包含一個旅程（MVP 範圍）
      - 如果使用者已購買該旅程：回傳 409 Conflict
      - 如果使用者已有該旅程的未付款訂單：回傳現有訂單（200 OK）
      - 訂單編號格式：`{timestamp}{userId}{randomCode}`
        - 範例：`20251121011117cd5` = `2025112101`（時間戳記）+ `11`（userId）+ `17cd5`（隨機碼）
      - 旅程價格在訂單建立時鎖定（來自 journeys.price）
      - 訂單狀態預設為 UNPAID
      - 訂單到期時間設定為 created_at + 3 天
      - 如果 3 天內未付款，訂單自動過期（狀態變更為 EXPIRED）

      **後續步驟：**
      - 前端應重新導向至訂單付款頁面
      - 使用者可透過 POST /orders/{orderId}/pay 完成付款
    operationId: createOrder
    security:
      - bearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../schemas/orders.yaml#/CreateOrderRequest'
          examples:
            create:
              summary: 為旅程建立訂單
              value:
                items:
                  - journeyId: 17
                    quantity: 1
    responses:
      '201':
        description: 訂單建立成功
        content:
          application/json:
            schema:
              $ref: '../schemas/orders.yaml#/OrderResponse'
            examples:
              created:
                summary: 新訂單已建立
                value:
                  id: 123
                  orderNumber: '20251121011117cd5'
                  userId: 11
                  username: 'john_doe'
                  status: 'UNPAID'
                  originalPrice: 7599.00
                  discount: 0.00
                  price: 7599.00
                  items:
                    - journeyId: 17
                      journeyTitle: 'AI x BDD：規格驅動全自動開發術'
                      quantity: 1
                      originalPrice: 7599.00
                      discount: 0.00
                      price: 7599.00
                  createdAt: 1732420800000
                  expiredAt: 1732680000000
                  paidAt: null
      '200':
        description: 使用者已有該旅程的未付款訂單，回傳現有訂單
        content:
          application/json:
            schema:
              $ref: '../schemas/orders.yaml#/OrderResponse'
            examples:
              existing:
                summary: 回傳現有未付款訂單
                value:
                  id: 120
                  orderNumber: '20251120011117a8f'
                  userId: 11
                  username: 'john_doe'
                  status: 'UNPAID'
                  originalPrice: 7599.00
                  discount: 0.00
                  price: 7599.00
                  items:
                    - journeyId: 17
                      journeyTitle: 'AI x BDD：規格驅動全自動開發術'
                      quantity: 1
                      originalPrice: 7599.00
                      discount: 0.00
                      price: 7599.00
                  createdAt: 1732334400000
                  expiredAt: 1732593600000
                  paidAt: null
      '400':
        description: 錯誤的請求 - 無效的旅程 ID
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              invalidJourney:
                summary: 無效的旅程 ID
                value:
                  error: '無效的旅程 ID'
      '401':
        description: 未授權 - 使用者未登入
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: 使用者未認證
                value:
                  error: '需要身份驗證'
      '404':
        description: 找不到旅程
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: 旅程不存在
                value:
                  error: '找不到旅程'
      '409':
        description: 衝突 - 使用者已購買此旅程
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              alreadyPurchased:
                summary: 使用者已擁有此旅程
                value:
                  error: '你已經購買此課程'

detail:
  get:
    tags:
      - Orders
    summary: 取得訂單詳細資訊
    description: |
      回傳特定訂單的詳細資訊。

      **需要認證：**
      - 使用者必須已登入
      - 使用者只能查看自己的訂單（嘗試存取其他使用者的訂單會回傳 404）

      **使用案例：**
      - 在付款頁面顯示訂單資訊（「完成支付」階段）
      - 付款後顯示訂單確認（「購買完成」階段）
      - 查看訂單歷史記錄

      **回應：**
      - 訂單基本資訊（訂單編號、狀態、價格）
      - 訂單項目（旅程資訊）
      - 時間戳記（created_at、paid_at（如適用））
    operationId: getOrderDetail
    security:
      - bearerAuth: []
    parameters:
      - name: orderId
        in: path
        required: true
        description: 訂單 ID
        schema:
          type: integer
          example: 123
    responses:
      '200':
        description: 成功取得訂單詳細資訊
        content:
          application/json:
            schema:
              $ref: '../schemas/orders.yaml#/OrderResponse'
            examples:
              unpaid:
                summary: 未付款訂單
                value:
                  id: 123
                  orderNumber: '20251121011117cd5'
                  userId: 11
                  username: 'john_doe'
                  status: 'UNPAID'
                  originalPrice: 7599.00
                  discount: 0.00
                  price: 7599.00
                  items:
                    - journeyId: 17
                      journeyTitle: 'AI x BDD：規格驅動全自動開發術'
                      quantity: 1
                      originalPrice: 7599.00
                      discount: 0.00
                      price: 7599.00
                  createdAt: 1732420800000
                  expiredAt: 1732680000000
                  paidAt: null
              paid:
                summary: 已付款訂單
                value:
                  id: 123
                  orderNumber: '20251121011117cd5'
                  userId: 11
                  username: 'john_doe'
                  status: 'PAID'
                  originalPrice: 7599.00
                  discount: 0.00
                  price: 7599.00
                  items:
                    - journeyId: 17
                      journeyTitle: 'AI x BDD：規格驅動全自動開發術'
                      quantity: 1
                      originalPrice: 7599.00
                      discount: 0.00
                      price: 7599.00
                  createdAt: 1732420800000
                  expiredAt: null
                  paidAt: 1732507200000
              expired:
                summary: 已過期訂單
                value:
                  id: 124
                  orderNumber: '20251118011117xyz'
                  userId: 11
                  username: 'john_doe'
                  status: 'EXPIRED'
                  originalPrice: 7599.00
                  discount: 0.00
                  price: 7599.00
                  items:
                    - journeyId: 17
                      journeyTitle: 'AI x BDD：規格驅動全自動開發術'
                      quantity: 1
                      originalPrice: 7599.00
                      discount: 0.00
                      price: 7599.00
                  createdAt: 1732161600000
                  expiredAt: 1732420800000
                  paidAt: null
      '401':
        description: 未授權 - 使用者未登入
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: 使用者未認證
                value:
                  error: '需要身份驗證'
      '404':
        description: 找不到訂單或使用者沒有查看此訂單的權限
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: 訂單不存在或存取被拒絕
                value:
                  error: '找不到訂單'

pay:
  post:
    tags:
      - Orders
    summary: 完成訂單付款
    description: |
      完成訂單付款並授予使用者旅程存取權。

      **需要認證：**
      - 使用者必須已登入
      - 使用者只能支付自己的訂單

      **業務邏輯：**
      - 訂單狀態必須為 UNPAID（已過期的訂單無法付款）
      - 付款成功後：
        - 訂單狀態變更為 PAID
        - 設定 paid_at 時間戳記
        - 使用者獲得旅程存取權（在 user_journeys 表中建立記錄）
      - 付款為模擬（MVP 中沒有整合實際的付款閘道）

      **注意：**
      - 在 MVP 中，點擊「立即支付」按鈕會自動完成購買
      - 實際的付款整合可在未來版本中加入
    operationId: payOrder
    security:
      - bearerAuth: []
    parameters:
      - name: orderId
        in: path
        required: true
        description: 訂單 ID
        schema:
          type: integer
          example: 123
    responses:
      '200':
        description: 付款完成成功
        content:
          application/json:
            schema:
              $ref: '../schemas/orders.yaml#/PayOrderResponse'
            examples:
              success:
                summary: 付款成功
                value:
                  id: 123
                  orderNumber: '20251121011117cd5'
                  status: 'PAID'
                  price: 7599.00
                  paidAt: 1732507200000
                  message: '付款完成'
      '401':
        description: 未授權 - 使用者未登入
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: 使用者未認證
                value:
                  error: '需要身份驗證'
      '404':
        description: 找不到訂單或使用者沒有權限
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              notFound:
                summary: 訂單不存在或存取被拒絕
                value:
                  error: '找不到訂單'
      '409':
        description: 衝突 - 訂單已付款或已過期
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              alreadyPaid:
                summary: 訂單已完成
                value:
                  error: '訂單已付款'
              expired:
                summary: 訂單已過期
                value:
                  error: '訂單已過期'
