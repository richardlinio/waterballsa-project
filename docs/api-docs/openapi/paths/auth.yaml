register:
  post:
    tags:
      - Auth
    summary: 使用者註冊
    description: |
      使用帳號與密碼註冊新使用者。

      **速率限制：**
      - 每個 IP 每小時最多 5 次註冊
      - 超過速率限制時回傳 400 與通用錯誤訊息（避免資訊洩漏）

      **驗證規則：**
      - 使用者名稱和密碼必須為英數字元，允許特殊字元
      - 兩者都有長度限制
      - 初始經驗值設為 0
      - 成功後重新導向至登入頁面
    operationId: register
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../schemas/auth.yaml#/RegisterRequest'
          examples:
            valid:
              summary: 有效的註冊
              value:
                username: 'john_doe123'
                password: 'SecurePass123!'
    responses:
      '201':
        description: 使用者註冊成功
        content:
          application/json:
            schema:
              $ref: '../schemas/auth.yaml#/RegisterResponse'
            examples:
              success:
                summary: 註冊成功
                value:
                  message: '註冊成功'
                  userId: 1
      '400':
        description: 請求資料無效或超過速率限制
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              invalidFormat:
                summary: 使用者名稱或密碼格式無效
                value:
                  error: '使用者名稱或密碼格式無效'
              rateLimited:
                summary: 超過速率限制（基於安全性的通用訊息）
                value:
                  error: '註冊失敗。請稍後再試。'
      '409':
        description: 使用者名稱已存在
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              duplicate:
                summary: 使用者名稱已被使用
                value:
                  error: '使用者名稱已存在'

login:
  post:
    tags:
      - Auth
    summary: 使用者登入
    description: |
      使用帳號與密碼進行使用者身分驗證。

      **速率限制：**
      - 每個 IP 每 15 分鐘最多 5 次失敗嘗試
      - 超過速率限制時回傳 401（與無效憑證相同以避免資訊洩漏）

      **安全性：**
      - 回傳 JWT 存取權杖（1 天後過期）
      - 權杖應包含在受保護端點的 Authorization 標頭中
    operationId: login
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../schemas/auth.yaml#/LoginRequest'
          examples:
            valid:
              summary: 有效的登入憑證
              value:
                username: 'john_doe123'
                password: 'SecurePass123!'
    responses:
      '200':
        description: 登入成功
        content:
          application/json:
            schema:
              $ref: '../schemas/auth.yaml#/LoginResponse'
            examples:
              success:
                summary: 登入成功
                value:
                  accessToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
                  user:
                    id: 1
                    username: 'john_doe123'
                    experience: 0
      '401':
        description: 憑證無效或超過速率限制
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              invalid:
                summary: 錯誤的使用者名稱或密碼
                value:
                  error: '使用者名稱或密碼無效'
              rateLimited:
                summary: 超過速率限制（基於安全性使用相同錯誤訊息）
                value:
                  error: '使用者名稱或密碼無效'

logout:
  post:
    tags:
      - Auth
    summary: 使用者登出
    description: |
      登出目前使用者並清除認證 Cookie。

      **不需要認證：** 此端點不要求有效的存取權杖，無論是否已登入皆可呼叫。

      **權杖失效化（盡力而為）：**
      - 若提供有效的存取權杖，會將其加入黑名單（儲存在資料庫中）
      - 若提供有效的重新整理權杖，會將其撤銷
      - 黑名單項目會在權杖過期時自動過期
      - 若權杖無效或未提供，仍會清除 Cookie 並回傳成功
    operationId: logout
    security: []
    responses:
      '200':
        description: 登出成功
        content:
          application/json:
            schema:
              $ref: '../schemas/auth.yaml#/LogoutResponse'
            examples:
              success:
                summary: 登出成功
                value:
                  message: '登出成功'

refresh:
  post:
    tags:
      - Auth
    summary: 刷新存取權杖
    description: |
      使用 Refresh Token 取得新的 Access Token。

      **注意：** Refresh Token 會透過 Cookie 自動傳送。
    operationId: refresh
    responses:
      '200':
        description: 權杖刷新成功
        content:
          application/json:
            schema:
              $ref: '../schemas/auth.yaml#/RefreshResponse'
            examples:
              success:
                summary: 刷新成功
                value:
                  accessToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
                  user:
                    id: 1
                    username: 'john_doe123'
                    experience: 0
      '401':
        description: 未授權 - Refresh Token 無效、過期或遺失
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              unauthorized:
                summary: Refresh Token 無效、過期或遺失
                value:
                  code: 'ERR_UNAUTHORIZED'
                  error: '未授權或權杖無效'
      '500':
        description: 伺服器內部錯誤
        content:
          application/json:
            schema:
              $ref: '../schemas/common.yaml#/ErrorResponse'
            examples:
              databaseError:
                summary: 資料庫操作失敗
                value:
                  code: 'ERR_DATABASE_ERROR'
                  error: '資料庫操作失敗'
              internalError:
                summary: 伺服器內部錯誤
                value:
                  code: 'ERR_INTERNAL_SERVER_ERROR'
                  error: '伺服器內部錯誤'
